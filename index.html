<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Annotation Interface Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .content {
            padding: 40px;
        }

        .scenario-box {
            background: #f8f9ff;
            border-left: 4px solid #4facfe;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .interface-container {
            background: white;
            border: 2px solid #e0e6ff;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e6ff;
            border-radius: 4px;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Improved Consent Screen */
        .consent-screen {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .consent-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .consent-section {
            margin: 25px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .consent-highlight {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #4facfe;
        }

        .consent-checkboxes {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #ffeaa7;
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-top: 3px;
            transform: scale(1.3);
        }

        .checkbox-group label {
            line-height: 1.5;
            font-size: 14px;
        }

        /* Valence-Arousal Plot Improvements */
        .va-plot {
            width: 500px;
            height: 500px;
            position: relative;
            margin: 20px auto;
            border: 3px solid #333;
            border-radius: 8px;
        }

        .quadrant {
            position: absolute;
            width: 50%;
            height: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .quadrant:hover {
            transform: scale(1.02);
            z-index: 5;
        }

        .quadrant.selected {
            border: 5px solid white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            transform: scale(1);
            z-index: 10;
        }

        .quadrant-title {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .quadrant-examples {
            font-size: 12px;
            line-height: 1.3;
            opacity: 0.9;
        }

        .hanv { background: #e74c3c; top: 0; left: 0; } /* High Arousal, Negative Valence - Red */
        .hapv { background: #f39c12; top: 0; right: 0; } /* High Arousal, Positive Valence - Yellow */
        .lanv { background: #3498db; bottom: 0; left: 0; } /* Low Arousal, Negative Valence - Blue */
        .lapv { background: #27ae60; bottom: 0; right: 0; } /* Low Arousal, Positive Valence - Green */

        /* Slider Interface */
        .slider-interface {
            max-width: 600px;
            margin: 0 auto;
        }

        .slider-group {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .slider-label {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        .slider-container {
            position: relative;
            margin: 20px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            font-weight: bold;
        }

        .slider-value {
            text-align: center;
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #4facfe;
        }

        /* Emotion Labels */
        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .emotion-btn {
            padding: 12px 16px;
            border: 2px solid #e0e6ff;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
        }

        .emotion-btn:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .emotion-btn.selected {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        /* Emotion Tree */
        .tree-container {
            text-align: center;
        }

        .tree-level {
            margin: 20px 0;
        }

        .breadcrumb {
            margin-top: 20px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        /* Metaphor Interface Style Improvements */
        .metaphor-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .metaphor-item {
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 4px solid transparent;
            transition: all 0.3s ease;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .metaphor-item:hover {
            transform: scale(1.05);
        }

        .metaphor-item.selected {
            border-color: white;
            transform: scale(1.08);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        /* Emoji Interface */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 20px 0;
        }

        .emoji-item {
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            border: 3px solid #e0e6ff;
            transition: all 0.3s ease;
            background: #f8f9ff;
            padding: 15px;
        }

        .emoji-item:hover {
            border-color: #4facfe;
            transform: scale(1.05);
            background: #e8f4fd;
        }

        .emoji-item.selected {
            border-color: #4facfe;
            background: #4facfe;
            color: white;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
        }

        .emoji-label {
            font-size: 14px;
            margin-top: 10px;
            font-weight: bold;
        }

        /* Simplified Rating Interface */
        .rating-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .rating-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .rating-row.rating-required-error {
            border: 2px solid #e74c3c;
            background-color: #fcebeb;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
        }

        .rating-stars {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .star {
            font-size: 28px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star.active {
            color: #ffd700;
        }

        .rating-labels {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
            font-weight: bold;
            color: #666;
        }

        /* Feelings Wheel Styles - Grid/Flexbox Design */
        .wheel-container {
            max-width: 700px;
            margin: 0 auto;
            text-align: center;
        }

        .wheel-level {
            margin: 20px 0;
            min-height: 200px; /* Reduced min-height */
            position: relative;
        }

        .core-emotions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 15px;
            justify-content: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .core-emotion {
            padding: 25px 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 3px solid transparent;
            aspect-ratio: 1; /* Makes it a circle */
        }

        .core-emotion:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .core-emotion.selected {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0,0,0,0.4);
            border: 3px solid white;
        }

        /* Colors for core emotions */
        .emotion-happy { background: #FFD700; }
        .emotion-sad { background: #4169E1; }
        .emotion-disgusted { background: #556b2f; }
        .emotion-angry { background: #DC143C; }
        .emotion-fearful { background: #483d8b; }
        .emotion-bad { background: #708090; }
        .emotion-surprised { background: #ff69b4; }

        .secondary-emotions-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px auto;
            max-width: 600px;
        }

        .secondary-emotion {
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
            border: 2px solid transparent;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .secondary-emotion:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border-color: white;
        }

        .secondary-emotion.selected {
            border-color: white;
            transform: scale(1.1);
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
        }

        .tertiary-emotions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 20px auto;
            padding: 20px;
            background: #e8f4fd;
            border-radius: 12px;
            max-width: 600px;
        }

        .tertiary-emotion {
            padding: 10px 14px;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 13px;
            border: 2px solid #e0e6ff;
        }

        .tertiary-emotion:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .tertiary-emotion.selected {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .wheel-breadcrumb {
            margin: 20px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            font-weight: bold;
        }

        /* MODIFICATION: Styles for new Contextual Factors interface */
        .context-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .context-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            gap: 10px;
            background: white;
            border: 2px solid #e0e6ff;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .context-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .context-label {
            font-size: 14px;
            font-weight: 600;
        }
        
        .context-item:hover {
            border-color: #4facfe;
            background: #f0f8ff;
            transform: translateY(-2px);
        }
        
        .context-item.selected {
            border-color: #4facfe;
            background: #e8f4fd;
            box-shadow: 0 4px 8px rgba(79, 172, 254, 0.2);
            transform: translateY(-2px);
        }

        /* Form Elements */
        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e6ff;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group textarea {
            height: 100px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .hidden {
            display: none;
        }

        .intensity-slider {
            width: 100%;
            margin: 20px 0;
        }

        /* Center content styles */
        .centered-content {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .step-indicator {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #2c5282;
        }

        /* Final Feedback Screen Styles */
        .feedback-screen {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .interface-comparison {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4facfe;
        }

        .interface-ranking {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 2px solid #e0e6ff;
        }

        .ranking-number {
            background: #4facfe;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border: 2px solid #e0e6ff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .radio-item:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .radio-item input[type="radio"]:checked + .radio-item,
        .radio-item:has(input[type="radio"]:checked) {
            border-color: #4facfe;
            background: #e8f4fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Emotion Annotation Interface Study</h1>
            <p>Help us understand which interface works best for daily emotion logging</p>
        </div>

        <div class="content">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Consent Screen (Now First) -->
            <div id="consentScreen">
                <!-- ... your consent screen HTML is unchanged ... -->
            </div>

            <!-- Demographics Screen (Now Second) -->
            <div id="demographicsScreen" class="hidden">
                <!-- ... your demographics screen HTML is unchanged ... -->
            </div>

            <!-- Main Interface Container -->
            <div id="mainInterface" class="hidden">
                <!-- ... your main interface HTML is unchanged ... -->
            </div>

            <!-- Final Feedback Screen -->
            <div id="finalFeedbackScreen" class="hidden">
                <!-- ... your final feedback screen HTML is unchanged ... -->
            </div>

            <!-- Results Screen -->
            <div id="resultsScreen" class="hidden">
                <div class="centered-content">
                    <h2>ðŸŽ‰ Thank You!</h2>
                    <p>Your responses have been recorded. This data will help improve emotion tracking interfaces.</p>
                    <div id="summary"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ======================= CHANGE #1: ADD FIREBASE SDKs ======================= -->
    <!-- These scripts load the Firebase services we need -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- =========================================================================== -->

    <script>
        // ======================= CHANGE #2: INITIALIZE FIREBASE =======================
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDIt-ChXmC_ToTZloYckBWcNFO3tmvcnbc",
            authDomain: "annosense-ui.firebaseapp.com",
            projectId: "annosense-ui",
            storageBucket: "annosense-ui.firebasestorage.app",
            messagingSenderId: "674765046133",
            appId: "1:674765046133:web:007c8ae575ed8e57ab533c",
            measurementId: "G-YXY0LTMNNY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Get a reference to the Cloud Firestore service
        const db = firebase.firestore();
        // ============================================================================


        // Global Variables
        let currentStep = 0;
        let currentInterface = 0;
        let surveyData = {
            userInfo: {},
            responses: [],
            finalFeedback: {},
            startTime: Date.now()
        };

        // ... ALL of your other JavaScript functions are unchanged ...
        // (coreScenarios, interfaces, proceedToDemographics, loadInterface, etc.)
        // ...
        // ... scroll down to the submitFinalFeedback function ...
        // ...

        // ======================= CHANGE #3: MODIFY THE SUBMIT FUNCTION =======================
        // This function is now 'async' and will save data to Firestore
        async function submitFinalFeedback() {
            // Validate required fields
            const bestInterface = document.querySelector('input[name="bestInterface"]:checked');
            const worstInterface = document.querySelector('input[name="worstInterface"]:checked');
            const usageContext = document.querySelector('input[name="usageContext"]:checked');
            
            if (!bestInterface) {
                alert('Please select your most preferred interface.');
                return;
            }
            
            if (!worstInterface) {
                alert('Please select your least preferred interface.');
                return;
            }
            
            if (bestInterface.value === worstInterface.value) {
                alert('Please select different interfaces for best and worst preferences.');
                return;
            }
            
            if (!usageContext) {
                alert('Please select a usage context.');
                return;
            }
            
            // Collect final feedback data
            surveyData.finalFeedback = {
                best_interface: bestInterface.value,
                best_interface_reason: document.getElementById('bestInterfaceReason').value,
                worst_interface: worstInterface.value,
                worst_interface_reason: document.getElementById('worstInterfaceReason').value,
                general_improvements: document.getElementById('generalImprovements').value,
                usage_context: usageContext.value,
                additional_comments: document.getElementById('additionalComments').value,
                feedback_timestamp: new Date().toISOString()
            };
            
            // Calculate total study time
            surveyData.total_time_minutes = Math.round((Date.now() - surveyData.startTime) / 1000 / 60);
            
            // --- NEW FIREBASE CODE TO SAVE DATA ---
            try {
                // Get a reference to the 'surveyResponses' collection in Firestore.
                // If the collection doesn't exist, it will be created automatically.
                const responsesCollection = db.collection("surveyResponses");
                
                // Add the entire surveyData object as a new document.
                // Firestore will auto-generate a unique ID for this document.
                const docRef = await responsesCollection.add(surveyData);
                
                console.log("Document successfully written with ID: ", docRef.id);
                alert("Thank you! Your response has been saved successfully.");

            } catch (error) {
                console.error("Error adding document to Firestore: ", error);
                // Alert the user that saving failed, so they can manually copy the data.
                alert("An error occurred while saving your response. Please copy the data from the next screen and send it to the researcher.");
            }
            // --- END OF FIREBASE CODE ---
            
            // This function now runs after the data has been saved (or failed to save)
            showResults();
        }
        // ===================================================================================

        function showResults() {
            document.getElementById('finalFeedbackScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            const summary = document.getElementById('summary');
            summary.innerHTML = `
                <h3>Survey Summary</h3>
                <p><strong>Interfaces tested:</strong> ${surveyData.responses.length}</p>
                <p><strong>Total time:</strong> ${surveyData.total_time_minutes} minutes</p>
                <p><strong>Most preferred interface:</strong> ${shuffledInterfaces.find(i => i.type === surveyData.finalFeedback.best_interface)?.name || 'N/A'}</p>
                <p><strong>Least preferred interface:</strong> ${shuffledInterfaces.find(i => i.type === surveyData.finalFeedback.worst_interface)?.name || 'N/A'}</p>
                <div style="margin-top: 20px;">
                    <h4>Your Data (for research purposes):</h4>
                    <textarea readonly style="width: 100%; height: 200px; font-family: monospace; font-size: 12px;">
${JSON.stringify(surveyData, null, 2)}
                    </textarea>
                </div>
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Survey is ready to start with consent screen
        });

        // --- PASTE ALL YOUR OTHER JAVASCRIPT FUNCTIONS HERE ---
        // (The ones I omitted for brevity, like proceedToDemographics, loadInterface, etc.)
    </script>
</body>
</html>
